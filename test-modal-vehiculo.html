<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modal Veh√≠culo - Flota</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; max-width: 90%; max-height: 90%; overflow-y: auto; z-index: 1001; }
        .d-none { display: none !important; }
    </style>
</head>
<body>
    <h1>üß™ Test Modal Veh√≠culo con Pesta√±as - Flota</h1>
    
    <div class="test-section info">
        <h3>1. Estado de Scripts</h3>
        <div id="scripts-status">Verificando...</div>
    </div>
    
    <div class="test-section info">
        <h3>2. Pruebas de Modal</h3>
        <button onclick="testNuevoVehiculo()" class="btn btn-primary">Probar Nuevo Veh√≠culo</button>
        <button onclick="testEditarVehiculo()" class="btn btn-success">Probar Editar Veh√≠culo (con pesta√±as)</button>
        <button onclick="testModalDirecto()" class="btn btn-warning">Probar Modal Directo</button>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section info">
        <h3>3. Estado del Modal</h3>
        <div id="modal-status">No hay modal activo</div>
    </div>
    
    <div class="test-section info">
        <h3>4. Logs de Consola</div>
        <div id="console-logs" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
        <button onclick="clearLogs()" class="btn btn-secondary">Limpiar Logs</button>
    </div>
    
    <!-- Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay d-none">
        <div id="modal-content" class="modal-content">
            <!-- El contenido del modal se insertar√° aqu√≠ -->
        </div>
    </div>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Application Scripts -->
    <script src="config.js"></script>
    <script src="api.js"></script>
    <script src="app.js"></script>
    <script src="modals.js"></script>
    <script src="vehiculo-tabs.js"></script>
    
    <script>
        console.log('=== TEST MODAL VEH√çCULO INICIADO ===');
        
        // Interceptar console.log para mostrar en la p√°gina
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToLogs(message, type = 'log') {
            const logsDiv = document.getElementById('console-logs');
            if (logsDiv) {
                const logEntry = document.createElement('div');
                logEntry.style.color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logsDiv.appendChild(logEntry);
                logsDiv.scrollTop = logsDiv.scrollHeight;
            }
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLogs(args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLogs(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLogs(args.join(' '), 'warn');
        };
        
        function addTestResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            if (resultsDiv) {
                const resultDiv = document.createElement('div');
                resultDiv.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} mt-2`;
                resultDiv.innerHTML = message;
                resultsDiv.appendChild(resultDiv);
            }
        }
        
        function updateModalStatus(message) {
            const statusDiv = document.getElementById('modal-status');
            if (statusDiv) {
                statusDiv.innerHTML = message;
            }
        }
        
        function clearLogs() {
            const logsDiv = document.getElementById('console-logs');
            if (logsDiv) {
                logsDiv.innerHTML = '';
            }
        }
        
        function testNuevoVehiculo() {
            console.log('üß™ Probando Nuevo Veh√≠culo...');
            addTestResult('üß™ Probando Nuevo Veh√≠culo...', 'info');
            
            try {
                if (typeof openModal === 'function') {
                    console.log('‚úÖ Funci√≥n openModal disponible');
                    addTestResult('‚úÖ Funci√≥n openModal disponible', 'success');
                    
                    console.log('üîÑ Llamando a openModal("vehiculo")...');
                    addTestResult('üîÑ Llamando a openModal("vehiculo")...', 'info');
                    
                    openModal('vehiculo');
                    addTestResult('‚úÖ openModal("vehiculo") ejecutado', 'success');
                    updateModalStatus('Modal de nuevo veh√≠culo abierto');
                } else {
                    console.log('‚ùå Funci√≥n openModal no disponible');
                    addTestResult('‚ùå Funci√≥n openModal no disponible', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error ejecutando openModal:', error);
                addTestResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        function testEditarVehiculo() {
            console.log('üß™ Probando Editar Veh√≠culo (con pesta√±as)...');
            addTestResult('üß™ Probando Editar Veh√≠culo (con pesta√±as)...', 'info');
            
            try {
                if (typeof openModal === 'function') {
                    console.log('‚úÖ Funci√≥n openModal disponible');
                    addTestResult('‚úÖ Funci√≥n openModal disponible', 'success');
                    
                    // Crear un veh√≠culo de prueba para editar
                    const vehiculoPrueba = {
                        id: 1,
                        placas: 'ABC123',
                        marca: 'Toyota',
                        modelo: 'Corolla',
                        anio: 2020,
                        estatus: 'disponible'
                    };
                    
                    console.log('üîÑ Llamando a openModal("vehiculo", vehiculoPrueba)...');
                    addTestResult('üîÑ Llamando a openModal("vehiculo", vehiculoPrueba)...', 'info');
                    
                    openModal('vehiculo', vehiculoPrueba);
                    addTestResult('‚úÖ openModal("vehiculo", vehiculoPrueba) ejecutado', 'success');
                    updateModalStatus('Modal de editar veh√≠culo abierto (deber√≠a mostrar pesta√±as)');
                } else {
                    console.log('‚ùå Funci√≥n openModal no disponible');
                    addTestResult('‚ùå Funci√≥n openModal no disponible', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error ejecutando openModal:', error);
                addTestResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        function testModalDirecto() {
            console.log('üß™ Probando Modal Directo...');
            addTestResult('üß™ Probando Modal Directo...', 'info');
            
            try {
                if (window.app && window.app.modalManager) {
                    console.log('‚úÖ ModalManager disponible');
                    addTestResult('‚úÖ ModalManager disponible', 'success');
                    
                    // Generar HTML del modal directamente
                    const vehiculoPrueba = {
                        id: 1,
                        placas: 'XYZ789',
                        marca: 'Honda',
                        modelo: 'Civic',
                        anio: 2021,
                        estatus: 'rentado'
                    };
                    
                    console.log('üîÑ Generando HTML del modal con pesta√±as...');
                    addTestResult('üîÑ Generando HTML del modal con pesta√±as...', 'info');
                    
                    const modalHTML = window.app.modalManager.getVehiculoModal(vehiculoPrueba);
                    console.log('‚úÖ HTML del modal generado:', modalHTML);
                    addTestResult('‚úÖ HTML del modal generado correctamente', 'success');
                    
                    // Mostrar el modal
                    const modalContent = document.getElementById('modal-content');
                    const modalOverlay = document.getElementById('modal-overlay');
                    
                    if (modalContent && modalOverlay) {
                        modalContent.innerHTML = modalHTML;
                        modalOverlay.classList.remove('d-none');
                        updateModalStatus('Modal directo mostrado (deber√≠a mostrar pesta√±as)');
                        
                        // Inicializar las pesta√±as si est√°n disponibles
                        if (window.vehiculoTabsManager) {
                            window.vehiculoTabsManager.setVehiculoId(vehiculoPrueba.id);
                            console.log('‚úÖ VehiculoTabsManager inicializado');
                            addTestResult('‚úÖ VehiculoTabsManager inicializado', 'success');
                        }
                    }
                } else {
                    console.log('‚ùå ModalManager no disponible');
                    addTestResult('‚ùå ModalManager no disponible', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error ejecutando modal directo:', error);
                addTestResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        // Verificar estado cuando se cargue la p√°gina
        window.addEventListener('load', function() {
            console.log('üîÑ P√°gina cargada, verificando scripts...');
            
            setTimeout(() => {
                console.log('üìä Verificando estado de la aplicaci√≥n...');
                
                // Verificar scripts
                const scripts = [
                    { name: 'config.js', check: () => typeof SUPABASE_CONFIG !== 'undefined' },
                    { name: 'api.js', check: () => typeof api !== 'undefined' },
                    { name: 'app.js', check: () => typeof FlotaApp !== 'undefined' },
                    { name: 'modals.js', check: () => typeof ModalManager !== 'undefined' },
                    { name: 'vehiculo-tabs.js', check: () => typeof VehiculoTabsManager !== 'undefined' }
                ];
                
                let status = '';
                scripts.forEach(script => {
                    const isLoaded = script.check();
                    const icon = isLoaded ? '‚úÖ' : '‚ùå';
                    const color = isLoaded ? 'success' : 'error';
                    status += `<p class="${color}">${icon} ${script.name}: ${isLoaded ? 'Cargado' : 'No cargado'}</p>`;
                });
                
                document.getElementById('scripts-status').innerHTML = status;
                
                // Verificar objetos principales
                if (window.app) {
                    console.log('‚úÖ window.app disponible');
                    if (window.app.modalManager) {
                        console.log('‚úÖ modalManager disponible');
                    } else {
                        console.log('‚ùå modalManager no disponible');
                    }
                } else {
                    console.log('‚ùå window.app no disponible');
                }
                
                if (typeof openModal === 'function') {
                    console.log('‚úÖ openModal disponible');
                } else {
                    console.log('‚ùå openModal no disponible');
                }
            }, 1000);
        });
        
        // Interceptar la funci√≥n openModal para debug
        const originalOpenModal = window.openModal;
        window.openModal = function(type, item = null) {
            console.log('üîç openModal interceptado:');
            console.log('- type:', type);
            console.log('- item:', item);
            console.log('- window.app:', window.app);
            
            if (window.app) {
                console.log('‚úÖ window.app disponible, llamando al m√©todo...');
                return window.app.openModal(type, item);
            } else {
                console.log('‚ùå window.app no disponible');
                addTestResult('‚ùå window.app no disponible al llamar openModal', 'error');
            }
        };
    </script>
</body>
</html>

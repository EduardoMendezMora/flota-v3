<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Completo - Flota</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .log { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        button { margin: 5px; padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico Completo del Sistema Flota</h1>
    
    <div class="section info">
        <h3>1. Estado de Scripts</h3>
        <div id="scripts-status">Verificando...</div>
    </div>
    
    <div class="section info">
        <h3>2. Estado de Objetos Globales</h3>
        <div id="objects-status">Verificando...</div>
    </div>
    
    <div class="section info">
        <h3>3. Estado de la Aplicaci√≥n</h3>
        <div id="app-status">Verificando...</div>
    </div>
    
    <div class="section info">
        <h3>4. Pruebas de Funcionalidad</h3>
        <button onclick="testOpenModal()">Probar openModal('vehiculo')</button>
        <button onclick="testOpenModalWithItem()">Probar openModal('vehiculo', {id: 1})</button>
        <button onclick="testDirectAppCall()">Probar window.app.openModal directamente</button>
        <div id="test-results"></div>
    </div>
    
    <div class="section info">
        <h3>5. Logs de Consola</h3>
        <div id="console-logs" class="log"></div>
        <button onclick="clearLogs()">Limpiar Logs</button>
    </div>
    
    <div class="section info">
        <h3>6. Verificaci√≥n de Modal Manager</h3>
        <div id="modal-manager-status">Verificando...</div>
    </div>
    
    <div class="section info">
        <h3>7. Verificaci√≥n de Vehiculo Tabs Manager</h3>
        <div id="tabs-manager-status">Verificando...</div>
    </div>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Application Scripts -->
    <script src="config.js"></script>
    <script src="api.js"></script>
    <script src="app.js"></script>
    <script src="modals.js"></script>
    <script src="vehiculo-tabs.js"></script>
    
    <script>
        console.log('=== DIAGN√ìSTICO COMPLETO INICIADO ===');
        
        // Interceptar console.log para mostrar en la p√°gina
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToLogs(message, type = 'log') {
            const logsDiv = document.getElementById('console-logs');
            if (logsDiv) {
                const logEntry = document.createElement('div');
                logEntry.style.color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logsDiv.appendChild(logEntry);
                logsDiv.scrollTop = logsDiv.scrollHeight;
            }
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLogs(args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLogs(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLogs(args.join(' '), 'warn');
        };
        
        function updateStatus(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = content;
                element.className = `section ${type}`;
            }
        }
        
        function addTestResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            if (resultsDiv) {
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${type}`;
                resultDiv.innerHTML = message;
                resultsDiv.appendChild(resultDiv);
            }
        }
        
        function testOpenModal() {
            console.log('üß™ Probando openModal("vehiculo")...');
            addTestResult('üß™ Probando openModal("vehiculo")...', 'info');
            
            try {
                if (typeof openModal === 'function') {
                    console.log('‚úÖ Funci√≥n openModal disponible');
                    addTestResult('‚úÖ Funci√≥n openModal disponible', 'success');
                    
                    console.log('üîÑ Llamando a openModal("vehiculo")...');
                    addTestResult('üîÑ Llamando a openModal("vehiculo")...', 'info');
                    
                    openModal('vehiculo');
                    addTestResult('‚úÖ openModal("vehiculo") ejecutado', 'success');
                } else {
                    console.log('‚ùå Funci√≥n openModal no disponible');
                    addTestResult('‚ùå Funci√≥n openModal no disponible', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error ejecutando openModal:', error);
                addTestResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        function testOpenModalWithItem() {
            console.log('üß™ Probando openModal("vehiculo", {id: 1})...');
            addTestResult('üß™ Probando openModal("vehiculo", {id: 1})...', 'info');
            
            try {
                if (typeof openModal === 'function') {
                    console.log('‚úÖ Funci√≥n openModal disponible');
                    addTestResult('‚úÖ Funci√≥n openModal disponible', 'success');
                    
                    console.log('üîÑ Llamando a openModal("vehiculo", {id: 1})...');
                    addTestResult('üîÑ Llamando a openModal("vehiculo", {id: 1})...', 'info');
                    
                    openModal('vehiculo', {id: 1});
                    addTestResult('‚úÖ openModal("vehiculo", {id: 1}) ejecutado', 'success');
                } else {
                    console.log('‚ùå Funci√≥n openModal no disponible');
                    addTestResult('‚ùå Funci√≥n openModal no disponible', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error ejecutando openModal:', error);
                addTestResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        function testDirectAppCall() {
            console.log('üß™ Probando window.app.openModal directamente...');
            addTestResult('üß™ Probando window.app.openModal directamente...', 'info');
            
            try {
                if (window.app && typeof window.app.openModal === 'function') {
                    console.log('‚úÖ window.app.openModal disponible');
                    addTestResult('‚úÖ window.app.openModal disponible', 'success');
                    
                    console.log('üîÑ Llamando a window.app.openModal("vehiculo")...');
                    addTestResult('üîÑ Llamando a window.app.openModal("vehiculo")...', 'info');
                    
                    window.app.openModal('vehiculo');
                    addTestResult('‚úÖ window.app.openModal("vehiculo") ejecutado', 'success');
                } else {
                    console.log('‚ùå window.app.openModal no disponible');
                    addTestResult('‚ùå window.app.openModal no disponible', 'error');
                }
            } catch (error) {
                console.error('‚ùå Error ejecutando window.app.openModal:', error);
                addTestResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        function clearLogs() {
            const logsDiv = document.getElementById('console-logs');
            if (logsDiv) {
                logsDiv.innerHTML = '';
            }
        }
        
        function checkScriptsStatus() {
            const scripts = [
                { name: 'config.js', check: () => typeof SUPABASE_CONFIG !== 'undefined' },
                { name: 'api.js', check: () => typeof api !== 'undefined' },
                { name: 'app.js', check: () => typeof FlotaApp !== 'undefined' },
                { name: 'modals.js', check: () => typeof ModalManager !== 'undefined' },
                { name: 'vehiculo-tabs.js', check: () => typeof VehiculoTabsManager !== 'undefined' }
            ];
            
            let status = '';
            scripts.forEach(script => {
                const isLoaded = script.check();
                const icon = isLoaded ? '‚úÖ' : '‚ùå';
                const color = isLoaded ? 'success' : 'error';
                status += `<p class="${color}">${icon} ${script.name}: ${isLoaded ? 'Cargado' : 'No cargado'}</p>`;
            });
            
            updateStatus('scripts-status', status);
        }
        
        function checkObjectsStatus() {
            let status = '';
            
            // Verificar window.app
            if (window.app) {
                status += '<p class="success">‚úÖ window.app: Disponible</p>';
                
                // Verificar modalManager
                if (window.app.modalManager) {
                    status += '<p class="success">‚úÖ window.app.modalManager: Disponible</p>';
                } else {
                    status += '<p class="error">‚ùå window.app.modalManager: No disponible</p>';
                }
            } else {
                status += '<p class="error">‚ùå window.app: No disponible</p>';
            }
            
            // Verificar api
            if (typeof api !== 'undefined') {
                status += '<p class="success">‚úÖ Variable api: Disponible</p>';
            } else {
                status += '<p class="error">‚ùå Variable api: No disponible</p>';
            }
            
            // Verificar openModal global
            if (typeof openModal === 'function') {
                status += '<p class="success">‚úÖ Funci√≥n openModal: Disponible</p>';
            } else {
                status += '<p class="error">‚ùå Funci√≥n openModal: No disponible</p>';
            }
            
            updateStatus('objects-status', status);
        }
        
        function checkAppStatus() {
            let status = '';
            
            if (window.app) {
                status += '<p class="success">‚úÖ FlotaApp instanciada</p>';
                
                // Verificar m√©todos principales
                const methods = ['openModal', 'closeModal', 'showSection', 'loadVehiculos'];
                methods.forEach(method => {
                    if (typeof window.app[method] === 'function') {
                        status += `<p class="success">‚úÖ ${method}: Disponible</p>`;
                    } else {
                        status += `<p class="error">‚ùå ${method}: No disponible</p>`;
                    }
                });
                
                // Verificar propiedades
                if (window.app.modalManager) {
                    status += '<p class="success">‚úÖ modalManager: Disponible</p>';
                } else {
                    status += '<p class="error">‚ùå modalManager: No disponible</p>';
                }
                
                if (window.app.currentSection) {
                    status += `<p class="success">‚úÖ currentSection: ${window.app.currentSection}</p>`;
                } else {
                    status += '<p class="error">‚ùå currentSection: No disponible</p>';
                }
            } else {
                status += '<p class="error">‚ùå FlotaApp no instanciada</p>';
            }
            
            updateStatus('app-status', status);
        }
        
        function checkModalManagerStatus() {
            let status = '';
            
            if (window.app && window.app.modalManager) {
                const modalManager = window.app.modalManager;
                status += '<p class="success">‚úÖ ModalManager instanciado</p>';
                
                // Verificar m√©todos
                const methods = ['getModalContent', 'loadModalData', 'getVehiculoModal'];
                methods.forEach(method => {
                    if (typeof modalManager[method] === 'function') {
                        status += `<p class="success">‚úÖ ${method}: Disponible</p>`;
                    } else {
                        status += `<p class="error">‚ùå ${method}: No disponible</p>`;
                    }
                });
                
                // Verificar propiedades
                if (modalManager.modalData) {
                    status += '<p class="success">‚úÖ modalData: Disponible</p>';
                } else {
                    status += '<p class="error">‚ùå modalData: No disponible</p>';
                }
            } else {
                status += '<p class="error">‚ùå ModalManager no disponible</p>';
            }
            
            updateStatus('modal-manager-status', status);
        }
        
        function checkTabsManagerStatus() {
            let status = '';
            
            if (window.vehiculoTabsManager) {
                status += '<p class="success">‚úÖ VehiculoTabsManager: Disponible</p>';
                
                // Verificar m√©todos
                const methods = ['setVehiculoId', 'switchTab'];
                methods.forEach(method => {
                    if (typeof window.vehiculoTabsManager[method] === 'function') {
                        status += `<p class="success">‚úÖ ${method}: Disponible</p>`;
                    } else {
                        status += `<p class="error">‚ùå ${method}: No disponible</p>`;
                    }
                });
            } else {
                status += '<p class="error">‚ùå VehiculoTabsManager: No disponible</p>';
            }
            
            updateStatus('tabs-manager-status', status);
        }
        
        // Ejecutar verificaciones cuando se cargue la p√°gina
        window.addEventListener('load', function() {
            console.log('üîÑ P√°gina cargada, ejecutando verificaciones...');
            
            // Esperar un poco para que todos los scripts se inicialicen
            setTimeout(() => {
                console.log('üìä Ejecutando diagn√≥stico completo...');
                checkScriptsStatus();
                checkObjectsStatus();
                checkAppStatus();
                checkModalManagerStatus();
                checkTabsManagerStatus();
            }, 1000);
        });
        
        // Interceptar la funci√≥n openModal para debug
        const originalOpenModal = window.openModal;
        window.openModal = function(type, item = null) {
            console.log('üîç openModal interceptado:');
            console.log('- type:', type);
            console.log('- item:', item);
            console.log('- window.app:', window.app);
            
            if (window.app) {
                console.log('‚úÖ window.app disponible, llamando al m√©todo...');
                return window.app.openModal(type, item);
            } else {
                console.log('‚ùå window.app no disponible');
                addTestResult('‚ùå window.app no disponible al llamar openModal', 'error');
            }
        };
    </script>
</body>
</html>
